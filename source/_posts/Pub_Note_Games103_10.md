---
title: Games103 10.Surface Waves
mathjax: true
category:
 - Games103
sortValue: 40000
---

模拟这个水面实际上就是在修改 Mesh 上的顶点的位置

Shallow Water Equation 是一个比较有效率的方法。

![Alt text](image.png)

- 流体模拟的方法非常多样，不同的方法在不同的情况下效率不同。
- 这节课讨论一个简单的模拟水面波的方法，后面会讨论更通用的方法。

![Alt text](image-1.png)

- 模拟流体主要有两种方法：拉格朗日方法和欧拉方法。
- 拉格朗日方法是将物理变量定义在随物体运动的物质点上，物质点运动时物理变量也会随之运动。或者说把这些点当作物体的分子，具有一些物理变量，比如温度、速度等。
- 欧拉方法是将物理变量定义在空间中的固定格子上，模拟时通过修改格子中的物理变量值来模拟物体的运动。
- 我们的方法更接近于欧拉方法。

![Alt text](image-2.png)

- 可以用高度场来表示水面，在不同的位置 x 上有不同的高度值 h，通过更新高度函数来模拟水面波。
- 高度场有一个局限性，不能表示卷浪这样的一个位置上有多个函数值的情况。
- 在不同位置上都形成了一个高度面，然后我们定义速度，表示水流以怎样的速度穿过这个高度面。
- 速度可以是正的也可以是负的，表示水流的方向。
- 我们也可以构造一个关于速度的函数，不同位置上有不同的速度值，可以是正的也可以是负的。

有了高度场和速度场之后，我们需要做的就是分别定义他们的更新函数。

![Alt text](image-3.png)

- 高度场的更新可以描述为这么一个偏微分方程。
- 由两个部分构成，第一部分 dh/dt，也就是高度场随时间的变化。
- 右边部分是高度乘速度然后对位置求导，怎么理解呢？
  - 高度乘速度表示单位时间的体积流量
  - 然后按照导数的定义 dx 看作是一个很小的距离。
  - 这样就可以看作这个很短的距离区间的右边部分的单位体积流量减左边部分的单位体积流量，那么就得到了单位时间这个区间水量的变化，然后除以 dx 就得到了高度在单位时间内的变化。

通过这个式子我们就把对 t 的求导转化为了对 x 的求导，这样就可以更新高度场了。

下面再来看看怎么更新速度场。

![Alt text](image-4.png)

- 速度场的更新分为三个部分：
  - 第一个部分叫做 advection（对流），意思就是说水流在流动的时候速度也应该随着水流一起流动，而不是在 x 上固定。不过这节课暂时先不讲，留到后面。
  - 第三部分叫做 external force（外力），比如说船后面螺旋桨推水，这个就是外力。这个我们直接忽略。

这样我们就得到了一个简化的公式：

![Alt text](image-5.png)

- 这个式子简单来说就是压强对位置的导数除以密度。
- 同样的按照上面的理解，我们可以考虑成中间的小水柱左边受到一个压强，右边收受到一个压强，也就是说在一个很小的范围内，速度的变化实际上是由左右的压强差来产生的。
- 为什么要除以密度呢？因为速度的变化和密度相关，密度越大，速度变化越大。类比于$ma = F$ 中的 m
- 这里额外提一句，我们的实现里边移动箱子产生水波是通过压强来实现的，而不是外力。

![Alt text](image-6.png)

- 对于上边的公式：
  - 我们根据链式法则把$\frac{d(hu)}{dx}$转为$\frac{udh+hdu}{dx}$
  - 然后我们把其中$\frac{udh}{dx}$这项忽略掉，这里我们做了一个简化，认为水面波在一个很小的范围内高度变化很小，所以我们可以忽略掉这一项。（这也是为什么叫做 shallow wave）
  - 进一步再求一次对 dt 的导数（这里中间忽略了一项，没听懂？？？）
- 对于速度场公式：
  - 对 x 求导
- 然后我们就可以发现上下有一个公共项，我们把他们合并起来，就得到了一个简化版的公式，这也就是 shallow wave equation。
- 前面这些推导其实本质上是想把 u 给干掉，这样我们只需要关心高度场就可以了。

下面我们要对这个微分方程进行求解，对它进行离散化：

![alt text](image-7.png)

- 转为一堆具有固定宽度的水柱，每个水柱有一个高度值。
- 模拟的时候实际上是使用固定步长的时间$\Delta t$来模拟的。

然后我们需要对时间求导，要怎么求导呢？

![alt text](image-8.png)

- 所谓 final difference 就是在很小的区间做差值来近似求导
- 从泰勒展开来看，实际上就是只考虑到了一阶导数，忽略了后面的所有项
- 选择前面的时间减现在的叫做 forward difference，选择后面的叫做 backward difference，这两种方法都是一阶的。

![alt text](image-9.png)

- 如果我们把前面的时间减后面的时间，可以把二阶导数项消除掉，这就是 central difference。这种方法更准确，因为他是二阶的。

前面我们的微分方程里边都是二阶导数，要怎么使用 central difference 来求解呢？

![alt text](image-10.png)

- 先求两个中间位置的一阶导，然后再用这两个一阶导求二阶导。

![alt text](image-11.png)

- 观察这个式子可以发现，实际上就是邻居减去两倍自己，这个东西叫做 Laplacian

前面我们计算了高度对时间的二阶导，下面我们再来求解压强对位置的二阶导。

![alt text](image-12.png)

- 跟前面完全一样
- 如果是二维的情况，邻居有四个，那么就是减去四倍自己

![alt text](image-13.png)

- 这样我们就得到了离散的 Shallow wave equation

$$h_i(t_0+\Delta t) = 2h_i(t_0) - h_i(t_0-\Delta t) +\frac{\Delta t^2 h_i}{\Delta x^2 \rho} (P_{i+1}+P_{i-1}-2P_i)$$

下面我们需要解决一个问题，就是体积的问题，很多时候会发现模拟的时候水会越来越多或者越来越少，我们希望体积始终保持不变。
![alt text](image-14.png)

- 对所有位置的高度求和，得到的就是总体积，模拟前后的体积应该是一样的。也就是最后这一项应该是 0。

有几种解决方式：

![alt text](image-15.png)

- 第一种方式把公式修改为这样，也就是把$P_i$拆成两个部分，然后把$h_i$改为$\frac{h_i-1+h_i}{2}$。
- 后边那项对于$h_i$来说写作：$(\frac{h_{i-1}+h_i}{2})(P_{i-1}-P{i})+(\frac{h_{i+1}+h_{i}}{2})(P_{i+1}-P_{i})$
- 对于$h_{i+1}$来说写作：$(\frac{h_{i}+h_{i+1}}{2})(P_{i}-P_{i+1})+(\frac{h_{i+2}+h_{i+1}}{2})(P_{i+1}-P_{i+2})$
- 可以看到其中一项相加可以抵消，也就是说所有位置的这些项累加起来一定为 0，所以体积是守恒的。

关于这个方案更多的细节可以查看这篇论文：
![alt text](image-16.png)

![alt text](image-17.png)

- 另一种更简单的方式是直接把$h_i$认为是一个常数，后面的项跟之前一样同样累加起来为 0，体积守恒。

![alt text](image-18.png)

- 把压强的公式带到前面的式子中，这样这个公式就全是一堆高度值了
- 前面这一项是个常数，简单一点直接用$\alpha$代替

![alt text](image-19.png)

- 在刚体模拟中有个 damping 的概念，流体也有阻尼的概念，叫做 viscosity，粘滞系数。因为流体不可能无限制地流下去，它会有一个让它停下来的趋势。
- 这个其实跟动量有很大关系，这里直接乘上一个系数$\beta$。为 1 的时候就是没有阻尼，为 0 的时候就是完全阻尼。

下面来讨论一下边界的问题

![alt text](image-20.png)

- 一般有两种处理方式：
  - Dirichlet boundary condition，在边界外假设高度是一个常数，比如说海面的边界。
  - Neumann boundary condition，在边界上假设高度的一阶导数是 0，也就是说左右的水面高度永远是一样的，永远不会有水流过来。通常用来模拟池塘，水到了边界会反弹回来。

![alt text](image-21.png)

- 把边界条件加上，我们的算法大概就是这样的

扩展到 3D：
![alt text](image-22.png)

Two-Way Coupling（双向耦合）：
![alt text](image-23.png)

- 也就是流固耦合，刚体如何影响流体，流体如何影响刚体。（实际上研究的时候 coupling 有很多，不只是刚体，还有气泡、空气、弹性体、布等等）
- 这里只讨论了刚体对流体的影响，也就是刚体怎么把水排出去，流体对刚体的影响，也就是浮力，这里就不讨论了。

![alt text](image-24.png)

- 如何把水排除呢，直接把刚体占据的空间里的水删掉是不行的，因为这样会导致总体积减少。
- 或者把水删掉后加到周围的格子上？很难决定加到哪些格子上。

![alt text](image-26.png)

- 我们认为排开的水会产生一个虚拟的高度（本质上是想构造一个虚拟的压强，不过我们把压强消除了，所以这里表现为一个虚拟的高度）
- 所以我们把原本$\alpha$乘上的那个压强项中的高度都改为虚拟高度

![alt text](image-25.png)

- 整理一下就得到这个公式

$b_i$和$b_{i+1}$表示，形成了这么一个方程组：

![alt text](image-27.png)

- 这里的挑战是，物体的位置是可以发生变化的，所以需要求解的变量也会发生变化。
- 那么所以为了解决这个问题呢，我们把这个统一用 laplacian 算子的形式来定义，这样就可以写成比较统一的形式。（需要虚拟高度的位置就有 laplacian 算子，不需要的位置就是 1）

![alt text](image-28.png)

- 最后得到我们最终的算法，先求出$h^{new}$，然后求出虚拟高度 v，再根据求出的虚拟高度重新更新$h^{new}$
- 另外这里引入了一个新的系数，因为如果直接模拟的话，拖动方块的时候会导致水波特别大，所以我们给虚拟高度乘上一个系数，让水波小一点。（当然这个不是物理上正确的，只是为了让效果看起来更合理）
- 为什么会导致水波特别大呢？因为我们这个求解的方式是一个显示积分的方式，显示积分的方式就会有不稳定性，所以如果拖动得很快的时候就会导致水波特别大。如果是隐式积分的方式就不会有这个问题。

![alt text](image-29.png)

- 流体对刚体的影响，也就是浮力，我们利用阿基米德定律，浮力等于排出去的水的重量，然后根据高度差乘以格子的宽度乘以密度乘以重力加速度就可以得到浮力。
- 实际的情况会更复杂，需要考虑旋转，也就是要考虑扭矩。

今天讲的是一个简化的模型，后面会更加正确的模拟流体。
