---
title: 从台本程序化生成过场动画序列
---

- [Procedurally Generating Level Sequences from a Dialogue Script | Unreal Fest 2024](https://www.youtube.com/watch?v=CAgTjb_8GFo)

## Introduction

这个工具可以从对话脚本生成对话序列。

![alt text](image-1.png)

- 专注于叙事性的 RPG
- 目前有两款游戏，The Council 和 Vampire the Masquerade-- Swansong，其中 Swansong 使用虚幻 4 制作

整个分享的结构：
![alt text](image.png)

- 要解决什么问题
- Dialogue Editor
- 介绍整个生成过程
- 后期编辑，如何处理自动生成-》手动编辑-》再次生成的问题，并且不丢失之前的编辑内容
- 一些 Sequencer 的陷阱

## Problem to solve

![alt text](image-2.png)

- 专注于叙事性的 RPG，所以存在大量的对话，非线性对话
- Swansong 在 20hr 的流程中塞入 140k words 的对话，对比巫师三这个密度也是很大的
- 所有这些对话都需要是带有摄像机、动画、字幕、口型同步等等的电影。

Previous Talks：
![alt text](image-3.png)

- [Behind the Scenes of the Cinematic Dialogues in The Witcher 3: Wild Hunt](https://www.youtube.com/watch?v=chf3REzAjgI)
- [Procedural Generation of Cinematic Dialogues in Assassin's Creed Odyssey](https://www.youtube.com/watch?v=DFM5zbekZ7c)
- 想把上述分享的内容做到 Unreal 中，所有东西都放在引擎里，因此在引擎内部制作了 Dialogue Editor 和 Sequence Generator
- 对话是自定义的特定资产。

## Dialogue Editor

![alt text](image-4.png)

- 你可以在内容浏览器中打开这个编辑器
- 创建 line、指定角色、表情、姿势
- 创建逻辑：选择、条件、对话的结尾
- 然后获取所有这些数据，使用它来创建 Sequence
- 除了对话，还可以处理文档、游戏元素和大部分书面内容，比如 Email 中的内容。所以在本地化等方面，一切都通过相同的流程。

![alt text](image-5.png)

- 在 Dialogue Editor 中，内容会自动拆分为序列。
- 因为选择或者条件而产生的每个分支，都会创建一个新的序列，例如这里的 seq420 和 seq436
- 你还可以用子对话细分你的对话，比如举个例子：开场动画-》对话-》返回游戏，但是 NPC 还会补充一些冒泡和旁白一样的对话。
  这样的一段整段对话就可以拆分为三个逻辑上的子对话，先是用 Cinematic 做一段开场动画，然后是 Main Dialogue（固定镜头对话），最后是所谓 Bark 对话。一会可以看到一个例子。

为什么选择 Sequencer 呢？
![alt text](image-6.png)

- 它是内置在引擎中的电影的标准工具，附带了很多操作，比如摄像机、事件、动画等等
- 最重要的是，我们希望我们的内容设计师能够更改生成的资产，所以我们希望他们能够在事后对其进行编辑。

## Dialogue Types

Swansong 中有三种对话类型：
![alt text](image-7.png)

- Staged Dialogue：标准的 RPG 对话，摄像机面对正在说话的人，动画和口型同步
- 3CDialogue and Barks：没有摄像头，角色可以自由移动，所以你不会把它锁在原地
- Cinematic：电影式的动画，这个部分我们只生成逻辑，没有摄像机、动画、口型同步等等。所以这是一张空的画布，都是由电影设计师修改的。

下面来看一个例子：
![alt text](image-8.png)

- 首先是 Cinematic 的开场动画，由手工制作，除了字幕和跳转

![alt text](image-9.png)

- 然后进入了 Staged Dialogue

![alt text](image-11.png)

- 这里有一个手动制作的镜头，用来展示死者

![alt text](image-10.png)

- 自动生成了选择

![alt text](image-12.png)

- 最后退出 Staged Dialogue，进入 3C Dialogue，这时候角色可以跑来跑去。

## Generating Process

![alt text](image-13.png)

- 这个生成过程有点痛苦，因为 Sequencer 实际上是用来做线性的事情的，而我们要做的是非线性的对话。
- 为整个对话制作一个大的 Sequence，称之为 Master Sequence。然后在其中创建子序列，这些子序列与我们在 Dialogue Editor 中显示的序列一一对应。
- 所以这些红色的子序列中的每一个都是对话的一个块，一个逻辑块。每当你有跳跃或选择时，都会有新的序列。
- 在这些子序列中有实际的过场动画、动画和事件。

![alt text](image-14.png)

- 还有这样的循环序列，因为 Sequencer 没有无限循环功能
- 这里所做的只是创建了一个序列，其中包含标准摄像机、标准 Idle 动画，并在末尾显示“请循环”的事件。

## Events

![alt text](image-15.png)

- 事件是序列和整个对话的支柱，因为我们在其中做所有的逻辑。
- 使用事件，按顺序完成每一行对话
- 有字幕、条件跳转、Go To、选择、蓝图动作等事件
- 对话结束时调用结束的蓝图函数，因为对话是非线性的，同一个对话可以有多个结尾。
- 我们获取Dialogue Editor中关联的所有数据，并将其放入Event的Payload中，在运行时使用它。

## Stage

![alt text](image-16.png)

- Stage 也就是舞台是一个特殊的蓝图 Actor，其中包含一堆摄像机组件、角色放在哪里的插槽、灯光等等
- 红色插槽是给玩家的，黄色是给 NPC 的
- 灯光将在运行时打开或关闭，具体取决于处于活动状态的摄像机。
- 每个子对话可以有一个 Stage，如果是 Cinematic 和 Bark，可能没有 Stage。
- Swansong 中有一个舞台的集合，根据角色的数量或姿势，选择一个舞台，因为有时候 NPC 会坐着，你可以从集合中选择。

那要如何选择相机呢？
![alt text](image-17.png)

- 每个相机切换至少 2.5 秒，最多 9 秒，因此如果句子很短，它们将共享相同的相机镜头，否则看起来会非常机械。
- 对于每个句子或每个镜头都会尝试一系列规则，如果通过规则就会获得权重，如果不通过就不会获得权重，最后选择最好的。
- 比如：
  - Player 是否可见
  - 玩家是否在选择循环中
  - 镜头是否与前一个镜头的电影感一致（因为你不希望在一个角色镜头过后，再次出现同一个角色的镜头只是角度略有不同）。
  - 还为摄像机提供了一些规则，以确保摄像机与混合兼容，因为在 Swansong 中，我们试图避免开始和结束对话的剪辑。所以有一条规则说，最后一个摄像机，如果它可以是对话的结尾，它必须在你的角色后面，这样你才能安全地混出。

![alt text](image-18.png)

- 要指定变量和元数据，我们只需要在舞台的摄像机组件中填充一堆变量。
- 它们过去是用 C++ 制作的，但是每次想改点东西都要找程序，最近改变了方向，将它们制作在蓝图中，以便设计师可以创建和修改它们。
- 这里的蓝图根据一些条件来给特定相机打分
- 可以把他们存储在数据表的预设中，对于某个对话甚至整个项目都可以设置所需的预设类型。

## Animation

![alt text](image-19.png)

- 基本上，我们有两种类型的动画
  - 标准姿势：基本上只是 Idle，动作很少，因为我们在其上添加了很多叠加动画。
  - 叠加手势，有两种类型：
    - 关键词手势：有描述一些关键词的数据集，然后对所有句子都进行音频分析，如果找到其中的一个关键词，就会尝试在那个时候使用关键词动画，但不要太多，也许每个句子一两个，这取决于句子的长度。
    - 填充手势：只是用填充手势填充空白，所以基本上，你的角色只是移动它的手臂。

![alt text](image-20.png)

- 过去常常将动画存储在 Data Table 中，但现在我们正在切换到 Data Asset，因为 Data Table 会很快变得非常大，最终会加载一堆你实际上不需要的东西。
- 每个 Posture 都有一个 Data Asset
- 例如这里是针对 Relax 的标准姿势，你可以看到表情、姿势类型以及与之相关的所有手势。
- 还有听众的手势
- 以及关键词手势：在生成时尝试获取这些数据，并在资产中找到最好的动画。

![alt text](image-21.png)

- 我们没有直接使用来自轨道的动画。而是正在将它们整合到动画蓝图中。
- 这样可以将他们与 Anim Graph 中的其他内容混合在一起，尤其是以无缝的方式切换的时候，这非常有用。

![alt text](image-22.png)

- 关于音频和口型同步，这是另外一回事。它们是录音后获得的资产，我们自己不生成，所以这里只是使用约定的命名
- 在生成时，如果我们找到这些资产，只需将其粘贴到其中即可。
- 根据音频时序进行所有操作，如果有 5s 的音频，就会尝试 5s 的动画。
- 当然，没有口型同步和音频预览会很痛苦，所以目前正在动态生成一些文本到语音和一些口型同步，即使它是占位符。

## Post-Generation Editing

![alt text](image-23.png)

- 困难的部分实际上是后期编辑，因为经常会有编辑后再次生成的情况，但是你不想丢失之前的编辑内容。
- 我们尝试制作一个系统，在生成游戏的同时可以保留所有手工制作的工作。
- 所做的可能类似于版本控制成像系统。

![alt text](image-24.png)

- Sequencer 中有锁定的标准功能，你只需右键单击并锁定，它就会变成红色。
- 当我们实际生成的时候，如果我们找到同名的锁定序列，我们直接把它粘贴到其中。
- 如果你的对话结构完全改变了，然后有一个 lock sequence，生成过程不知道该放在哪里，它会给出提示。

![alt text](image-25.png)

- 可以只选择生成你想要的东西，比如只生成子序列、摄像机、音频或事件等等。
- 以及一些保存的文件夹，这些文件夹受到保护，不会生成
- 在 Swansong 中，我们添加了 Audio、Light 和 VFX 文件夹。
- 可以在内容和项目设置中设置。
- 当然，我们必须对其添加一些质量检查
- 你也可以 lock 整个对话，只需一个复选框，如果你尝试生成，会显示一条警告，提示 No。

![alt text](image-26.png)

- 在所有这些实验之后，我们得出的结论：需要最大限度地减少对生成的需求，生成越少，错误和冲突就越少。
- 另外，在 Swansong 中，我们把 Dialogue Editor 中的数据复制到 Sequence 的 Event 的 Payload 中，这样在运行时，你就不必去寻找对话中的内容。但这存在一个问题，如果 Dialogue Editor 中修改了，Event 就过时了，所以为了解决这个问题，我们只存储 ID。

## Sequencer Pitfalls（陷阱）

![alt text](image-27.png)

- Event 的可读性太差了，而且查看很麻烦，所以开始尝试改为自定义轨道，不过这个部分文档很少，需要自己啃源码。
- 甚至可以使用这个小东西来混合动画轨道，并在此处使用它来混合字幕或任何你想要的内容。
- 它可以节省大量时间。

![alt text](image-28.png)

- 自动为每行命名帧，并带有行的 ID。
- Unreal 内部有一堆原生函数，它们允许你跳到标记的帧、找到下一个帧，它非常适合跳来跳去。
- 这也是我们现在用来跳过句子的方法。
- 每次保存序列时，我们都会重新计算它们应该在的位置。因为电影设计师可能会修改一些内容并更改字幕的值，或者将其放在其他位置。

![alt text](image-29.png)

- 如果使用 possessable，它将预览你的角色移动。如果你在这个特定时间保存地图，角色将停留在这个地方并被保存在这个位置。
- 在 World Save 上添加了一个安全机制。每次保存地图或自动保存时，在 PreSave 上，也就是在保存之前，关闭 Sequencer，这将导致所有角色回到他们的游戏位置。保存后，我们在右侧帧处重新打开 Sequencer。
- 当开始播放编辑器会话时，也会自动关闭 Sequencer，因为如果你在编辑器中打开了一个 Transform 轨迹，并且你在编辑器中播放相同的对话，可能会遇到一些非常卡顿的错误，因为 Sequencer 不知道该信任哪一个。

![alt text](image-30.png)

- 使用多个相机 Actor 而不是相机组件
- 为每个从中复制数据的相机组件生成相机 Actor。

![alt text](image-31.png)

- 如果角色在墙壁周围，相机可能会出现在墙内，这是一个运行时问题。
- 需要一些运行时策略，例如每次进行摄像机剪切时，都会检查摄像机是否有效。射线检测能看到头部吗？然后动态的选择一个相机。
- 如果找不到合适的位置混出，直接剪切吧。

## Final Words

![alt text](image-32.png)

- 这个工具创建过场动画非常快
- 可以即时预览，有文本到语音转换，可以立即播放对话
- 可以随意修改
- 现在正在集成一些第三方音频
