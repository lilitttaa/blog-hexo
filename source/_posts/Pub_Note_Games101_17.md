---
title: Games101 17.Materials and Appearances
---

## Materials and Appearances

![Alt text](image.png)

- 外观是光线和材质共同作用的结果
- 为什么海浪可以看透过去，深海浅海颜色不一样？
- 为什么我们能看到洞穴中一束光打下来？这说明有光线被重新导向打到了人眼，这个现象叫做散射。
- 为什么头发周围这一圈透光性特别强？
- 为什么我们一眼就知道这是布料，这是金属？
- 为什么蝴蝶的翅膀由各种各样的鳞片组成，为什么叠起来之后会显示出不同的颜色？
- 为什么我们能看到彩虹现象，为什么更多的高阶的彩虹我们就看不到？
- 光线打到鱼肉上，为什么会有透明的感觉，但又不是完全透明？这个叫次表面散射。
- 自然界的材质何止成千上万，但是我们现在接触的渲染器支持的材质种类有限，比如蒙塔数码的蒙多快渲染器支持 40 种材质（这可能是世界上最强的渲染器了）。

![Alt text](image-1.png)

- 材质就是 BRDF

![Alt text](image-2.png)

- 认为空间中从任何一个方向进来的光，它的 radiance 都是一样的，也就是所谓 uniform 的。
- 因为是漫反射，所有反射出去的光也都是 uniform 的

![Alt text](image-3.png)

- 因为入射光是 uniform 的所以与$\omega$无关，brdf 也是个常数。所以可以把这两项从积分中提出来。
- 对 cos 在半球上积分得到$\pi$
- 如果我们引入$\rho$，$L_0 = \rho L_i$，那么$\rho L_i = \pi f_r L_i$，所以$f_r = \frac{\rho}{\pi}$
- 这个$\rho$就是我们所说的反射率，它在 0~1 之间，可以是单通道的，也可以是三个数，也可以是光谱。

![Alt text](image-4.png)

- 有一点镜面但又不是完全的镜面反射的材质，这个叫做 Glossy

![Alt text](image-5.png)

- 一部分光线被反射，一部分光线被吸收，一部分光线被折射。这种材质通常是玻璃或者水。
- 左边的光会进入 water 材质里边，也就是有折射，这也是为什么我们能看到水里边的灰色。

![Alt text](image-6.png)

- 完美的镜面反射，入射角等于出射角。
- 根据平行四边形法则，入射光方向加上反射光方向等于法线方向。
- 或者也可以从俯视角向量相反的角度来看。
- 这其实也是为什么在 Blinn-Phong 模型中，我们计算的是半向量而不是反射方向，因为反射方向计算起来麻烦一些。

就能得到这样一个效果：
![Alt text](image-7.png)

- 所有反射都能用 BRDF 来描述，但是镜面反射的 BRDF 要写起来并不容易。里边涉及到 delta 函数，这里就不多说了。
- 它的分布集中在镜面反射方向上。

下面是关于折射（refraction）：
![Alt text](image-8.png)

- 平行光经过棱镜折射后，不同波长的光被分解成不同的光线。
- 折射现象在这个光的色散现象中仍然是采用几何光学的形式来描述，没有涉及到波之类的。
- 下边水底这个现象叫做 costics（国内翻译为焦散，但是这个翻译不合适，因为这个现象只有聚焦没有散射）。
- costics 是因为光线打到海水表面，海水表面凹凸不平，光线会往不同方向折射，对于海底的某一个点来说，它有几率接收到来自不同方向的光线。对于 Path Tracing 来说，这个现象是灾难性的考验。

![Alt text](image-9.png)

- 又叫折射定律，指入射角和出射角的正弦与折射率满足一定关系。
- 钻石的折射率非常高，也就是说光线进入钻石后会被折射的非常厉害，这就是为什么我们看到钻石会有各种各样的颜色。

![Alt text](image-10.png)

- 这样我们就能把折射角给算出来
- 如果根号内的式子小于 0，那么就意味着折射不可能发生。也就是右边这一项大于 1。又因为$1-\cos^2\theta_i$不可能大于 1，所以只有可能是折射率的比值大于 1。
- 也就是说从一个密介质进入一个稀介质，可能会发生全反射现象，此时没有折射。

如果把这个现象反过来，这个现象叫做 snell's window/Circle：
![Alt text](image-11.png)

- 只有锥形区域的光线能够被看到，这个角度有人算出来是 97.2 度。
- 全反射现象很容易发生，之前光线追踪的时候为什么没有遇到？是因为球有很好的对称的性质，所以折射进去的光线一定能折射出来。但是如果是复杂的形状，比如兔子，那么就有可能发生全反射。
- 折射也得对应一种 BRDF，这个 BRDF 叫做 BTDF，也就是 transmit，表示折射。
- 不过我们平时很少严格区分 BRDF 是指反射还是各种反射折射都包括在内。

Fresnel Reflection/Term（菲涅尔项）：
![Alt text](image-12.png)

- 垂直往下看，没有什么反射。但如果是斜着看，就会有反射。
- 也就是说有多少光被反射是和入射光的角度有关的。
- 菲涅尔项解释了有多少能量发生了反射，有多少能量发生了折射。

![Alt text](image-13.png)

- 这是绝缘体的情况
- 如果入射角度和法线垂直，那么就认为大量的能量会被反射掉，反之大量能量会折射。
- 简单提一下，另外两条线表示所谓的极化的性质，与光的波动性有关。我们平常不用管这个极化现象，目前也没有什么渲染器真的在考虑极化。

![Alt text](image-14.png)

- 这是导体的情况
- 这也反映了为什么我们用银质的镜子，因为银质的镜子在任何情况下都有很高的反射率。

菲涅尔项的计算：
![Alt text](image-15.png)

- 菲涅尔项得到的就是一个反射率，它是一个 0~1 之间的数。
- 根据不同的极化，会得到不同的反射率。我们不考虑极化的话，就是把这两个反射率平均一下。
- 不管怎么复杂，菲涅尔项一定和入射光的角度有关，也和折射率有关（也就是 n1、n2）。
- 人们通常会用一个简化方法，叫做 schlick's approximation，也就是说我们把这个菲涅尔项近似成一个一维的曲线，这个曲线在 0 度的时候是某一个值，然后在 90 度的时候是另一个值，然后在中间的时候是一个曲线，这个曲线是一个比较好的近似。

## Microfacet Material

![Alt text](image-16.png)

- 就像在卫星图里看地球，从远处看，地球是一个平面，但实际上地球是有山有建筑，有这样的高低起伏的。
- 也就是说，我们认为地球是一个平面，但它也能把光导向不同的方向。

所谓微表面模型也就是这个意思：
![Alt text](image-17.png)

- 近处凹凸不平的几何，远处可以看作是粗糙的平面。
- 对于近处的表面我们认为它是完全的镜面反射。
- 所谓漫反射就是在近处的这些“小镜子”方向几乎是随机的，也就是说它会把光线反射到四面八方。
- 这些微笑的镜面也有自己的法线，也就是说每一个微表面都有自己的朝向。我们可以关注这些微表面的法线分布。

![Alt text](image-18.png)

- Glossy 材质法线基本是集中在朝上的方向
- Diffuse 材质法线分布分得开
- 也就是说微表面模型利用了这个思想，用微表面的法线分布来表示表面的粗糙程度。

![Alt text](image-19.png)

- 我们现在主要关注上面的三项
- 首先是菲涅尔项，根据不同的入射方向有不同的反射率，也就是考虑了反射的能量。
- 然后最右边的 D 项，这部分考虑了法线的发布，也就是把入射方向和出射方向的半向量带入到法线分布函数里边。这个函数会告诉我们有多少微表面能够把入射方向的光反射到出射方向上去。
- 中间的 G 项，这个项考虑了微表面之间的遮挡和阴影，也就是说有一些微表面会挡住另外一些微表面，这样就会有一些微表面反射不出来。什么时候容易发生这种自遮挡呢？就是当光线几乎是平的打到表面上的时候，也叫做 grazing angle。

微表面模型可以得到非常高质量的渲染效果：
![Alt text](image-20.png)

- 这里的木头需要提一下，要描述它还需要基于微表面模型再引入一些别的东西。
- 这个模型无论是在电影还是游戏中都是非常有统治力的。
- 当然微表面模型有自己的问题，比如说它的 diffuse 很少，所以需要在上面额外加入一些漫反射的东西，这样就不是基于物理的了。
- 微表面模型是一个统称，有很多不同的微表面模型，比如 Cook Torrence 模型、Ward 模型等等。

## Isotropic and Anisotropic

![alt text](image-21.png)

- 电梯周边的金属，按理来说高光应该是一个圆或者椭圆，但是这里是一条一条的，这是为什么？
- 这个金属是被磨过的，从微表面结构上看，它是一条一条的沟。
- 这就是各向异性材质，也就是说它的微表面有明确的方向性。
- 另外一种是各向同性材质，也就是说它的微表面没有明确的方向性，或者说方向性很弱。

![alt text](image-22.png)

- 各向异性的材质法线分布有方向性

反映在 BRDF 上就是这样：
![alt text](image-23.png)

- 前面我们提到过从俯视角去看反射，那里有个方位角。如果我们保持入射光和出射光的相对方位角一致，旋转这个方位角，得到的 BRDF 还是一样的，那么这个材质就是各向同性的。如果不一样，那么就是各向异性的。
- 右边这个门把手的各向异性的地方还不一样

生活中很多各向异性的材质几乎都是人造的：
![alt text](image-24.png)

- 因为这个锅是一圈一圈被刷的，所以有这种辐射状的高光
- 这个 VRay 是一个商用渲染器，它和各种建模软件有联系，广泛应用。
  ![alt text](image-25.png)
- 水平和竖直一样，但是对角线不一样
  ![alt text](image-26.png)
- 天鹅绒，其实它本身已经不是表面了，不过我们当成表面处理
- 你可以把这些天鹅绒的表面的纤维拨到一边，人为的改变它各向异性的效果

## Properties of BRDFs

![alt text](image-28.png)

- 因为 BRDF 表示能量的分布，所以它的值一定是非负的
- 关于线性性质，之前我们在 Blinn-Phong 模型中把计算分成了高光、漫反射、环境光，然后分别计算，最后把结果加起来。
- BRDF 也有这个性质，也就是说 BRDF 可以分成很多块，分别计算。

![alt text](image-29.png)

- 光路可逆：也就是说我们把入射方向和出射方向反过来，BRDF 的值一定是一样的。
- 能量守恒：BRDF 一定不会让能量变多，所有入射的能量一定小于等于出射的能量。不满足那就不会收敛而是会爆炸。

![Alt text](image-30.png)

- 各向同性 BRDF 的值跟相对方位角有关，而和绝对方位角无关，这样就可以把四维的 BRDF 降到三维。
- 另外，再考虑到可逆性，我们可以得到各向同性 BRDF 相对方位角还可以不考虑正负。这对于 BRDF 的测量和存储都是有用的。

## Measuring BRDFs

为什么要测 BRDF 呢？
![Alt text](image-31.png)

- 像我们之前用的近似的菲涅尔项，跟物理测量的结果还是有差距的。
- 用物理测量的结果一些模型就可以不用推导了，直接用测量的数据。

怎么测呢？
![Alt text](image-32.png)

- 对着一个着色点，改变入射方向，找一个灯从四面八方照射，然后用一个相机从四面八方拍摄，这样就可以覆盖所有的入射和出射方向。

![Alt text](image-33.png)

- 这个仪器叫做 gonioreflectometer，它是一个球面，上面有两个爪子，一个爪子可以抓相机，一个爪子可以抓光源，然后把样本放在球心。
- 可以精确到 0.1 度。

![Alt text](image-34.png)

- 通过各项同性的假设，我们可以把四维的 BRDF 降到三维。
- 相对方位角不考虑正负，又可以减少一半的测量。

![Alt text](image-35.png)
![Alt text](image-36.png)

- 要把 BRDF 存下来，就需要大量的存储空间。
- 关于这块的研究也有很多压缩的研究，也有说用什么神经网络来做压缩，也是一个比较热门的话题。

![Alt text](image-37.png)

- 介绍一个很有名的 BRDF 的库，叫做 MERL Database
- 这个 MERL 是三菱电子实验室，这是和 MIT 在一块合作的项目。
- 他们测量了很多不同的材质，假设都是各项同性的。后来又加了一些各项异性。
- 对于各向同性材质，每个材质都取了 90x90x180 这么多次测量，存在一个三维的数组里面。这是一个非常大的存储量。
