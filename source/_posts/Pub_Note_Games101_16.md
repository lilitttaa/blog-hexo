---
title: Games101 16.Ray Tracing 4(Monte Carlo Path Tracing)
---

## Monte Carlo Integration

![Alt text](image.png)

- 蒙特卡洛积分是用来解决定积分的问题的
- 我们要想算一个函数的定积分，比如说从 a 到 b，通常是求它的原函数，也就是算不定积分，然后算 a 和 b 的值，然后相减
- 但是如果函数比较复杂，不好解析，那这个积分怎么做呢？这时候就需要用数值方法。

![Alt text](image-1.png)

- 我们先回忆一下积分定义时的黎曼积分的概念，就是把曲线分解成很多小的长方形，然后求和。
- 蒙特卡洛积分是另外一种积分方法，是考虑一种随机的采样的方法。
- 在 a 和 b 之间随机取一个数，然后找到它的 y 值，然后假设整个曲线是一个长方形，高度是刚才取的值，宽度是 a 和 b，然后用这个长方形的面积来近似曲线下围出来的面积。
- 我们随机采样很多次，然后把这些长方形的面积加起来，求平均，就能得到一个相对准确的结果。

![Alt text](image-2.png)

- 蒙特卡洛涉及到要在随机变量上采样，因此它本身是已经应用了概率分布的方法。
- 所以如果我们直接把采样的结果进行积分，实际上是期望的积分，为了消除这个影响，我们需要除以概率密度函数的值，这样就能得到真正的积分结果。

![Alt text](image-3.png)

- 采样的次数越多，得到的结果就越准确。
- 为什么这里没有 b-a 了呢？因为实际上已经被概率密度函数体现在里面了，所以我们不需要再考虑这个。
- 所以只要我们知道了函数与概率密度函数（pdf），我们就可以用蒙特卡洛积分来解决定积分的问题。
- 蒙特卡洛积分有一个显而易见的要求，就是我们只能在积分的变量上采样，不能随便找另外一个变量来做蒙特卡洛的积分的近似。比如这里只能在 x 上采样，不能在 z 上积分。

## Path Tracing

前面我们提到的 Whitted-Style 的 Ray tracing 有什么问题呢？
![Alt text](image-4.png)
![Alt text](image-5.png)

- 对于 Specular 的物体确实是镜面反射，但是对于这种 Glossy 的物体，它是有一定粗糙度的，所以我们不能认为它是完全的镜面反射。
  ![Alt text](image-6.png)
- Whitted-Style 对于 Diffuse 的物体直接就停下来了，但实际上应该是继续往四面八方散射的。
- 比如左边的天花板完全是黑的，但实际上是应该可以反射到的。
- 也没法体现 Color Bleeding 的效果，比如红墙反射红色到左边的盒子上。
- Cornell Box 是一个用来测试全局光照效果的一个有名的模型，而且它是真实存在的。

渲染方程是正确的，但是存在两个问题：
![Alt text](image-7.png)

- 一个是积分，我们可以用蒙特卡洛积分来解决。
- 然后是递归的问题

![Alt text](image-8.png)

- 虽然是入射光，但是我们还是跟 Blinn-Phong 模型一样，写成从这个点出发的向量。

![Alt text](image-9.png)

- 我们先不考虑自发光和多次反射，只考虑直接光照。
- pdf 我们简单的考虑为任何一个方向的概率都是相同的，根据立体角的定义：单位球的球面面积，也就是$\frac{1}{4\pi}$。再考虑到半球，所以是$\frac{1}{2\pi}$。

![Alt text](image-10.png)

- 注意这里边的两个 P，其中一个是 pdf，另一个是 P 点。

我们已经可以写出一个着色的算法了：
![Alt text](image-11.png)

- 随机选择 N 个方向，如果打到光源，就计算出来累加到结果里。

如果我们要引入间接光照，我们就要考虑反射的问题：
![Alt text](image-12.png)

- P 点的入射光，可以直接看作从 P 点去观察 Q 点，然后算 Q 点的直接光照。这样就跟我们之前算直接光完全是一样的了。

![Alt text](image-13.png)

- 这个算法是递归的

这样我们就得到了 Path Tracing 算法，但是这个算法还存在一些问题：
![Alt text](image-14.png)

- 如果每次反射都要打出 N 个光线，那么光线的数量会爆炸式增长。

![Alt text](image-15.png)

- 只有 N=1 的时候，这个指数才不会爆炸。而 Path Tracing 的 N 就是为 1 的，N 大于 1 时叫做 Distributed Ray Tracing。
- n 为 1 时噪声大，不过它还是对的。

那噪声大的问题怎么解决呢？

Ray Generation：
![Alt text](image-16.png)
![Alt text](image-17.png)

- 很简单，我们只要用足够多的 pass 就可以了。每个像素多计算几次，然后求平均。
- 可以在一个像素内选取很多不同的样本。
- 从相机位置连一根光线到样本位置。

还有一个问题是目前我们的递归它并不会停止。
![Alt text](image-18.png)

- 但如果我们在某个阈值停止，也会有问题，因为这样会损失能量，因为真实世界光线就是会无限弹射下去的。

那要怎么解决这个问题呢？Russain Roulette（俄罗斯轮盘赌）：
![Alt text](image-19.png)

- 我们用 RR 来决定在一定的概率下停止追踪。

![Alt text](image-20.png)

- 通过上面的公式，我们可以看到期望还是跟之前的结果一样的。

我们把这个终止条件加上去：
![Alt text](image-21.png)

现在我们已经得到了一个正确的 Path Tracing 算法。但这个算法现在效率太低了：
![Alt text](image-22.png)

- 需要在高的采样下才能得到好的结果。

要怎么优化呢？
![Alt text](image-23.png)

- 在不同场景下，光源大小不一样，当光源很小的时候，我们需要打很多光线才能打到光源，而光源很大的时候，我们只需要打几根光线就能打到光源。
- 那这样很多光线就浪费了
- 我们希望能够直接在光源上采样，这样就不会浪费光线了。
- 只要我们能找到一个更好的 pdf，然后用这个 pdf 来采样，我们可能采样的效果就比往四面八方这样要好。

那么最简单的就是直接在光源上采样：
![Alt text](image-24.png)

- 不管光源是大是小，我们都直接在光源上采样，这样就不会浪费光线了。
- 正如我们前面说的，蒙特卡洛积分要求在积分的变量上采样，这里也是一样的。
- 所以我们需要修改渲染方程，使得它是对光源面积上的积分。

我们需要找到立体角和光源面积之间的关系：
![Alt text](image-25.png)

- 根据立体角的定义，也就是找到单位球上的面积和光源面积之间的关系。也就是把光源面积投影到单位球上。
- 看前后法线的一个变换，就能得到投影到立体角方向上的面积。需要乘上 $cos\theta^{\prime}$。
- 最后然后除以距离的平方，就能得到单位球上的面积。

重写渲染方程：
![Alt text](image-26.png)

现在我们的着色来源于两个部分：

- 光源的直接贡献，我们可以直接采样光源来解决。
- 其他所有非光源的贡献，我们还是用之前的方法。

![Alt text](image-27.png)

- 直接光部分不需要使用俄罗斯轮盘赌。

![Alt text](image-28.png)

最后我们还需要考虑直接光被挡住的情况：
![Alt text](image-29.png)

这样整个 Path Tracing 算法就完成了。

点光源对于路径追踪来说是非常难处理的，所以如果真的需要一个点光源的场景，可以把它做成一个很小的面积光源。

![Alt text](image-30.png)

- Path Tracing 是比较现代的算法。

![Alt text](image-31.png)

- Path Tracing 得到一个绝对正确的结果

![Alt text](image-32.png)

- 过去 Ray Tracing 就是指 Whitted-Style 的光线追踪，现在我们把所有的光线传播方法的大集合叫做光线追踪。
- 比如单向/双向的 Path Tracing
- Photon Mapping（光子映射）
- Metropolis Light Transport（MLT）
- VCM（结合双向追踪和光子映射）
- UPBP（结合所有方法）

还有一些我们没有涉及到的内容：
![Alt text](image-33.png)

- 给定任意一个函数，我们怎么去采样它
- 重要性采样，也就是说对于不同形状的函数，我们怎么去采样才能得到最好的结果
- 随机数的扎推问题，这些相对离的较远的随机数序列叫做低差异序列

![Alt text](image-34.png)

- 我们采样涉及到了针对半球采样以及针对光源采样，能不能把这两种采样方法结合起来，使得效果会更好。这涉及到一个理论叫做 Multiple Importance Sampling（MIS），这是一个当前研究的热点。
- 我们把不同 pass 的结果加起来，会不会不应该是简单的平均，比如像素中心的 pass 贡献多一点，两边的少一点，这就涉及到 Pixel Reconstruction Filter 的概念。
- 我们最后得到的结果是 Radiance，但是我们看到的是颜色，Radiance 和颜色不是线性对应的，我们需要做 Gamma Correction，这个涉及到不同的曲线，比如 High Dynamic Range（HDR）的曲线。
