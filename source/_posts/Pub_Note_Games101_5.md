---
title: Games101 5.Rasterization 1 (Triangles)
---

光栅化是关于怎么把我们前面的-1~1 的三次方的立方体画到屏幕上的过程

## Perspective Projection

在正交投影中如何定义视野的长方体呢？
![Alt text](image.png)
其实就是用 l、r、b、t、n、f 这六个参数来定义这个长方体

然后透视投影我们是把 frustum 变成一个长方体，这个 frustum 怎么定义呢？

- 首先用 aspect ratio 来定义宽高比
- 另外用 fovY（field of view）来定义能看到的角度范围，上下中点夹角的角度。
  - 广角相机的广角其实就是指的这个角度比较大
  - 如果这个角度比较小，透视投影就越不明显，就越像正交投影。
  - 另外，像大家打游戏会涉及到水平的可视角度，这个水平的可视角度和垂直的可视角度是可以相互转化的。

![Alt text](image-1.png)

### What's After MVP?

![Alt text](image-2.png)

- MVP 过后，我们得到的是一个-1~1 的三次方的立方体，然后我们要把这个立方体画到屏幕上。

## Canonical Cube to Screen

- 在图形学上，我们把屏幕抽象成一个二维的数组，数组中的每一个元素是一个像素。像常见的屏幕分辨率 1920x1080，就是 1920 个像素宽，1080 个像素高。

![Alt text](image-3.png)

- 光栅化（rasterization）其中的 raster 本来是德语中的一个词，表示屏幕，然后把这个名词变成动词，就是把东西画在屏幕上的过程。

- 像素这个名字本来是叫做 picture element，然后缩写成 pixel，一个像素代表一个固定的颜色，可以是 0-255 的灰度，也可以是 RGB 三个值，每个值是 0-255。

什么叫屏幕空间呢？
![Alt text](image-5.png)

- 其实就是在屏幕中建立一个坐标系，可能会有各种不同的定义，我们这里把左下角定义为原点，向右是 x，向上是 y。
- 一个像素的中心在哪里呢？其实是在 x 加 0.5 和 y 加 0.5 上。

然后我们需要把之前的-1~1 的三次方的立方体映射到屏幕上
![Alt text](image-4.png)

- 关于 z 值的处理，暂时先不管，后面会讲到。
- x 跟 y 的转换就很简单了

这里相当于我们获取了场景的一张虚拟的照片，但它还是空间中描述的一堆三角形，我们要真正的把它变为像素表示的图，也就是光栅化的过程。
![Alt text](image-6.png)

## Drawing Machines

在说光栅化之前，我们来看一些绘制的机器：

![Alt text](image-7.png)

![Alt text](image-8.png)

## Different Raster Displays

以及各种光栅化的显示设备：

### 示波器

示波器：
![Alt text](image-9.png)
早期的很多电脑显示器就是这样
![Alt text](image-10.png)
可以形成各种不同的曲线
示波器本身是一个成像设备，和早期的显示器的成像原理一样

### 阴极射线管

下面这个叫做阴极射线管：
![Alt text](image-11.png)

左边的 Electron Emitter 产生很多的电子，然后穿过显示设备，发生偏转，偏在不同的位置上。这个过程进行的足够快，就可以形成一个完整的图像。这个是非常早期的屏幕，叫做 crt 屏幕。这个屏幕非常伤眼睛。

![Alt text](image-12.png)

早期的电视或者电脑显示器，都是通过扫描的方式，把一个一个的点打在屏幕上，从屏幕左上角开始，画一道又一道的线，不断的换行。

然后有一个技术叫做隔行扫描，就是画一半，然后再画另一半，这样可以减少一半的工作量，因为人眼有视觉暂留的效应，所以也可以看到完整的画面。这个技术直到现在还在一些视频压缩里面起到一些作用。

不过这个隔行扫描会造成画面撕裂，尤其是高速运动的画面，就会有这种鬼影的现象。

### Frame Buffer

给定一个显示器要怎么知道到底要显示什么呢？

- 显示器通过显卡里的内存（显存）中的一块区域来映射到屏幕上
- 下面是红白机上的 space invaders：
  ![alt text](image-13.png)

### LCD

现在的主要显示设备是 lcd：
![alt text](image-14.png)
现在的手机屏幕分辨率已经超过了人眼的分辨率，这种屏幕叫视网膜屏幕。

lcd 叫做液晶显示器，它是利用液晶的原理来控制一个像素，通过不同排布影响光的极化（光的偏振方向）。
![alt text](image-15.png)

- 一个像素它有两个不同的光栅，两个光栅以不同的方向进行排布，光经过光栅指挥，只有一个方向的光能通过。然后再通过液晶的扭曲，把光的振动方向调过来，这样就可以控制光的方向。
- OnState 中光右边通过竖直光栅，然后通过液晶扭曲，变成水平光栅，然后就可以通过水平光栅了。而 OffState 则无法通过水平光栅。

### LED（Light Emitting Diode）

简单来说就是发光二极管，要么发光，要么不发光。

![alt text](image-16.png)

### E-Ink

![alt text](image-17.png)

通过电压来控制墨水微粒是在上面还是在下面，这样就可以控制黑白。不过这种显示器刷新率很低。

## Rasterization

Polygon Meshes（多边形网格）：
![alt text](image-18.png)
Triangle Meshes（三角形网格）：
![alt text](image-19.png)
复杂图形可以用很多的三角形来表示，为什么我们认为三角形在图形学中会得到广泛应用呢？
![alt text](image-20.png)

- 首先它是最基础的多边形，没有比他更少的边了
- 其他任何不同的多边形都可以拆成三角形
- 三角形的三个点可以定义一个平面，而四边形就不行，比如沿着对角线折叠就不是平面了
- 多边形内部可能有洞
- 多边形可能不是凸多边形
- 可以通过向量的叉积来判断一个点是否在三角形内
- 可以利用重心坐标来进行插值

光栅化中最重要的一个概念：就是判断像素的中心点与这个三角形的位置关系。

### Sampling

我们通过采样来做光栅化：

![alt text](image-22.png)

- 所谓采样就是给定一个函数，它是连续的。然后在不同的地方去问这个函数的值是多少。
- 采样其实就是把一个这个函数给离散化的过程
- 在图形学里面会涉及到各种不同的采样，比如这里我们是对屏幕空间这个区域进行采样，然后之后还会有时间采样，位置采样，函数采样等等。
- 采样的函数可以是物体表面的反射性质，也可以是核磁共振成像的结果，也可以是医学成像的结果等等。

我们现在需要做的就是有这么一个 inside 函数，用来判断像素的中心是否在三角形内。
![alt text](image-24.png)
![alt text](image-23.png)
![alt text](image-25.png)

这个 inside 的函数要怎么确定呢，这要用到我们之前提到的叉积的概念。
![alt text](image-26.png)

- 按逆时针叉乘，点始终在向量的左边。
- 然后，这个会有一个边界问题，比如点刚好在三角形的边上，这个时候我们可以自己定义一个标准，比如说在边界上不算在三角形内，也可以定义在边界上算在三角形内。
- 对于 OpenGL 或者 DirectX 这样的 API，他们有着非常严格的规定，比如说他们认为上边和左边一定是在三角形内，如果有点落在这个三角形上边和左边的话，那这两个点这个点都认为在三角形内，如果落在右边和下边的话都不算。

另外，刚才我们是把所有像素都走了一遍，其实没必要，三角形只覆盖了部分区域，可以通过 bounding box（aix aligned bounding box 或者 AABB）来优化。
![alt text](image-27.png)

如果每行都从三角形的左边到右边，这样其实可以做到不多计算任何一个像素：
![alt text](image-28.png)

现实中的 LCD 屏幕：
![alt text](image-29.png)

左边：一个像素其实由红绿蓝三个不同的条组成
右边：绿色的点其实要比这个红色和蓝色的都要多，因为人眼对绿色最敏感，很多相机也是这么设计的，人眼会更舒服。

![alt text](image-31.png)

我们最后得到了一个这样的图形，它的形状基本上跟三角形一致，但是可以看到有很明显的锯齿：
![alt text](image-30.png)

- 锯齿是图形学一直在致力于解决的一个严重问题
- 这个在信号处理中叫做走样（aliasing）
- 下一步我们需要做的就是抗锯齿或者反走样（anti-aliasing）
